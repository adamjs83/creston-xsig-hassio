# v1.5.0 Exact Code Changes

## Summary
- **Files changed:** 2 required + 7 optional
- **Lines changed:** 3 required + 7 optional
- **Risk level:** LOW
- **Time required:** 30 minutes

---

## Required Changes

### File 1: __init__.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/__init__.py`

#### Change 1: Import Statement (Line 9)

**REMOVE:**
```python
from homeassistant.helpers.discovery import async_load_platform
```

**ADD:**
```python
from homeassistant.helpers import discovery
```

**Full context (lines 1-15):**
```python
"""The Crestron Integration Component"""

import asyncio
import logging

import voluptuous as vol

import homeassistant.helpers.config_validation as cv
from homeassistant.helpers import discovery  # ← CHANGED THIS LINE
from homeassistant.helpers.event import TrackTemplate, async_track_template_result
from homeassistant.helpers.template import Template
from homeassistant.helpers.script import Script
from homeassistant.core import callback, Context
from homeassistant.const import EVENT_HOMEASSISTANT_STOP
from homeassistant.const import (
```

#### Change 2: Platform Loading (Lines 82-84)

**REMOVE:**
```python
        for platform in PLATFORMS:
            # Use async_create_task to properly run platform loading in the background
            hass.async_create_task(async_load_platform(hass, platform, DOMAIN, {}, config))
```

**ADD:**
```python
        # Load platforms in parallel and wait for completion
        await asyncio.gather(
            *[
                discovery.async_load_platform(hass, platform, DOMAIN, {}, config)
                for platform in PLATFORMS
            ]
        )
```

**Full context (lines 72-87):**
```python
async def async_setup(hass, config):
    """Set up a the crestron component."""

    if config.get(DOMAIN) is not None:
        hass.data[DOMAIN] = {}
        hub = CrestronHub(hass, config[DOMAIN])

        await hub.start()
        hass.bus.async_listen_once(EVENT_HOMEASSISTANT_STOP, hub.stop)

        # Load platforms in parallel and wait for completion  # ← CHANGED
        await asyncio.gather(                                 # ← CHANGED
            *[                                                # ← CHANGED
                discovery.async_load_platform(hass, platform, DOMAIN, {}, config)  # ← CHANGED
                for platform in PLATFORMS                     # ← CHANGED
            ]                                                 # ← CHANGED
        )                                                     # ← CHANGED

    return True
```

---

### File 2: manifest.json

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/manifest.json`

#### Change: Version Number (Line 4)

**BEFORE:**
```json
{
  "domain": "crestron",
  "name": "Crestron XSIG Integration",
  "version": "1.4.0",
  "documentation": "https://github.com/adamjs83/crestron_custom_component/blob/main/README.md",
  "issue_tracker": "https://github.com/adamjs83/crestron_custom_component/issues",
  "dependencies": [],
  "codeowners": [
    "@adamjs83"
  ],
  "requirements": [],
  "iot_class": "local_push"
}
```

**AFTER:**
```json
{
  "domain": "crestron",
  "name": "Crestron XSIG Integration",
  "version": "1.5.0",  ← CHANGED THIS LINE
  "documentation": "https://github.com/adamjs83/crestron_custom_component/blob/main/README.md",
  "issue_tracker": "https://github.com/adamjs83/crestron_custom_component/issues",
  "dependencies": [],
  "codeowners": [
    "@adamjs83"
  ],
  "requirements": [],
  "iot_class": "local_push"
}
```

---

## Optional Changes (Recommended for Version Tracking)

Update `sw_version` in device_info from "1.4.0" to "1.5.0" in all platform files.

### File 3: light.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/light.py`

**Line 92:**
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 85-93):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

---

### File 4: climate.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/climate.py`

**Two occurrences:**

#### Occurrence 1 (Line 224 - CrestronThermostat class):
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 217-225):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

#### Occurrence 2 (Line 430 - CrestronFloorWarmingThermostat class):
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 423-431):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

---

### File 5: sensor.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/sensor.py`

**Line 88:**
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 81-89):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

---

### File 6: switch.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/switch.py`

**Line 79:**
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 72-80):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

---

### File 7: binary_sensor.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/binary_sensor.py`

**Line 80:**
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 73-81):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

---

### File 8: cover.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/cover.py`

**Line 116:**
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 109-117):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

---

### File 9: media_player.py

**Location:** `/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron/custom_components/crestron/media_player.py`

**Line 114:**
```python
# BEFORE
sw_version="1.4.0",

# AFTER
sw_version="1.5.0",
```

**Full context (lines 107-115):**
```python
    @property
    def device_info(self) -> DeviceInfo:
        """Return device info for this entity."""
        return DeviceInfo(
            identifiers={(DOMAIN, f"crestron_{self._hub.port}")},
            name="Crestron Control System",
            manufacturer="Crestron Electronics",
            model="XSIG Gateway",
            sw_version="1.5.0",  # ← CHANGED THIS LINE
        )
```

---

## Complete File List

### Required Changes (MUST DO)
1. `__init__.py` - 2 changes (1 line import, 3 lines platform loading)
2. `manifest.json` - 1 change (version number)

### Optional Changes (RECOMMENDED)
3. `light.py` - 1 change (line 92)
4. `climate.py` - 2 changes (lines 224, 430)
5. `sensor.py` - 1 change (line 88)
6. `switch.py` - 1 change (line 79)
7. `binary_sensor.py` - 1 change (line 80)
8. `cover.py` - 1 change (line 116)
9. `media_player.py` - 1 change (line 114)

**Total changes:** 10 lines across 9 files (or 3 lines across 2 files if skipping optional)

---

## Before You Start

### 1. Create Backup
```bash
cd "/Users/adamjs83/Library/Mobile Documents/com~apple~CloudDocs/aiworkflows/crestron"
cp custom_components/crestron/__init__.py custom_components/crestron/__init__.py.v1.4.0.backup
```

### 2. Verify Home Assistant Version
Check that you're running Home Assistant 2024.x or newer

### 3. Document Current State
- Take screenshot of entity list
- Note any deprecation warnings in logs
- Export list of automations using this integration

---

## After Changes

### 1. Restart Home Assistant
Required to load the new code

### 2. Check Logs
Look for:
- "Setting up crestron" - should appear
- Any errors with "crestron" - should NOT appear
- Deprecation warnings - should NOT appear

### 3. Verify Entities
All entities should:
- Appear in entity list
- Have same entity_id as before
- Show correct states
- Respond to commands

### 4. Check Device Registry
Navigate to: Settings → Devices & Services → Crestron
- Should see "Crestron Control System" device
- Click on it - should show all entities

---

## Verification Commands

### Check for Deprecation Warnings
```bash
grep -i "deprecat" /config/home-assistant.log | grep -i crestron
```
Should return: NO RESULTS (empty)

### Check Platform Loading
```bash
grep "Setting up crestron" /config/home-assistant.log
```
Should return: 7 lines (one for each platform)

### Check for Errors
```bash
grep -i "error" /config/home-assistant.log | grep -i crestron
```
Should return: NO RESULTS (empty)

---

## Success Criteria

All of these MUST be true:
- [ ] Home Assistant starts without errors
- [ ] No deprecation warnings in logs
- [ ] All 7 platforms load (binary_sensor, sensor, switch, light, climate, cover, media_player)
- [ ] All entities present (same count as before)
- [ ] All entity IDs unchanged
- [ ] All entities respond to commands
- [ ] Device appears in device registry
- [ ] State restoration works after restart

If ANY criterion fails: **ROLLBACK IMMEDIATELY** using the backup

---

## Rollback Procedure

1. Stop Home Assistant
2. Restore backup: `cp custom_components/crestron/__init__.py.v1.4.0.backup custom_components/crestron/__init__.py`
3. Revert manifest.json to version 1.4.0
4. Revert all sw_version changes if made
5. Start Home Assistant
6. Verify functionality restored
7. Document what went wrong

---

## Need Help?

- Full implementation plan: `v1.5.0_IMPLEMENTATION_PLAN.md`
- Quick reference: `v1.5.0_QUICK_REFERENCE.md`
- This file: `v1.5.0_EXACT_CHANGES.md`
